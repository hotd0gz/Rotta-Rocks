# NT Headers



## Introduction

In order to understand this page, we need to recap on Relative Virtual Addresses (RVA). An RVA is just an offset from where the image was loaded in memory (The Image base Virtual Address). **To Translate RVA into an absolute virtual address we **<mark style="color:yellow;">**add the value of the RVA to the value of the Image Base Address.**</mark>

**To summarize:**

1. Physical Memory Address is what CPU sees
2. Virtual Addreess (VA) is relative to Physical Address, per process (managed by OS)
3. RVA is relative to VA (file base or section base), per file (managed by linker and loader)



## NT Headers (IMAGE\_NT\_HEADERS)

The structure is defined in two different versions. One for 64 bit and one for 32 bit.

```c
typedef struct _IMAGE_NT_HEADERS64 {
    DWORD Signature;
    IMAGE_FILE_HEADER FileHeader;
    IMAGE_OPTIONAL_HEADER64 OptionalHeader;
} IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;

typedef struct _IMAGE_NT_HEADERS {
    DWORD Signature;
    IMAGE_FILE_HEADER FileHeader;
    IMAGE_OPTIONAL_HEADER32 OptionalHeader;
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
```

### Signature

The first member of the NT Header structure is the Signature. It's a DWORD which means it occupies 4 bytes. It always has a fixed value of `0x50450000` which translates to `PE\0\0` in ASCII.

Here is the view in PE Bear:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>



### FileHeader (IMAGE\_FILE\_HEADER)

Also called the "COFF File Header", the FileHeader struct holds information about the PE file. Here is the struct:

```c
typedef struct _IMAGE_FILE_HEADER {
    WORD    Machine;
    WORD    NumberOfSections;
    DWORD   TimeDateStamp;
    DWORD   PointerToSymbolTable;
    DWORD   NumberOfSymbols;
    WORD    SizeOfOptionalHeader;
    WORD    Characteristics;
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
```

* **Machine**: This is the CPU architecture. Weâ€™re only interested in two of them, `0x8864` for `AMD64` and `0x14c` for `i38`
* **NumberOfSections**: Holds the number of sections. (size of the section table).
* **TimeDateStamp**: When the file was created
* <mark style="color:yellow;">**SizeOfOptionalHeader**</mark>: The size of the optional header.



## OptionalHeader (IMAGE\_OPTIONAL\_HEADER)

<mark style="color:yellow;">The Optional Header is the most important header of the NT Headers.</mark> The PE Loader looks for specific information in this header to be able to load the executable. **This header is essential for executable files.**

It doesn't have a fixed size which is why the `IMAGE_FILE_HEADER.SizeOfOptionalHeader` exists.

