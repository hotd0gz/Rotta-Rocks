# Self Deleting Malware

## Introduction

A not so well known feature of the New Technology File System (NTFS) is the support for multiple _<mark style="color:yellow;">**data streams**</mark>_. Alternate data streams allow files to contain more than one stream of data. It's purpose was primarily to allow compatibility with Macintosh systems.

Every file has at least one data stream:  **In Windows, the default data stream is** <mark style="color:yellow;">**:$DATA**</mark>.

## Data Streams

Since **:$DATA** exists on every file, it can be an alternate way to access any file. Any applications that creates, looks at, or depends on the end of a file name (or extension) should be aware of alternate data streams. <mark style="color:yellow;">**Unsanitized user input could use the :$DATA stream to change the behavior of the program.**</mark>

### Creating Alternate Data Streams

* `C:\> type C:\windows\system32\notepad.exe > c:\windows\system32\calc.exe:notepad.exe`
* `C:\> start c:\windows\system32\calc.exe:notepad.exe`

### Accessing the :$DATA Alternate Data Stream

* `C:\> start c:\textfile.txt::$DATA`

### Exploiting Data Stream to show ASP code

In some vulnerable versions of IIS, we can exploit the data stream extension to view source code.

Normal Access:

* ```
  http://www.alternate-data-streams.com/default.asp
  ```

Exploited to show code:

* ```
  http://www.alternate-data-streams.com/default.asp::$DATA
  ```



## Deleting a Running Binary

As we know it is not possible to delete a running binary on Windows, since deleting a file requires that no other process is using it.

One way to get around this is by <mark style="color:yellow;">**renaming**</mark>** the default data stream **<mark style="color:yellow;">**:$DATA**</mark>** to another name that represents a new data stream.**&#x20;

We then can we can delete the newly renamed data stream, causing the binary to be wiped from disk.

### Retrieve File Handle

We first need to retrieve the file handle of the binary.

The file handle can be retrieved using the **`CreateFile`** WinAPI. The [access flag](https://learn.microsoft.com/en-us/windows/win32/secauthz/access-mask) must be set to **`DELETE`** to provide file deletion permissions.

### Renaming The Default Data Stream

We now can rename the default data stream of the running binary. We can use  [SetFileInformationByHandle](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-setfileinformationbyhandle) WinAPI with the `FileRenameInfo` flag.

The `SetFileInformationByHandle` WinAPI function is shown below.

```c
BOOL SetFileInformationByHandle(
  [in] HANDLE                    hFile,                       // Handle to the file for which to change information.
  [in] FILE_INFO_BY_HANDLE_CLASS FileInformationClass,        // Flag value that specifies the type of information to be changed
  [in] LPVOID                    lpFileInformation,           // Pointer to the buffer that contains the information to change for 
  [in] DWORD                     dwBufferSize                 // The size of 'lpFileInformation' buffer in bytes
);
```

###

### Delete The Data Stream

We then delete the  `:$DATA` stream to erase the file from the disk.&#x20;

To do so, the same **`SetFileInformationByHandle`** WinAPI will be used, with a different flag, **`FileDispositionInfo`** This flag marks the file for deletion when its handle is closed.





## Final Code

