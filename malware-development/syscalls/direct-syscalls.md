---
description: >-
  Syscalls (direct syscalls or system calls) are an interface for programs to
  interact with the system. This page is specific to Windows System Calls.
---

# Direct Syscalls

***

## Introduction

All syscalls return a NTSTATUS value that indicates the status (or error) code of the operation.&#x20;

The majority of syscalls are not documented by Microsoft, therefore the syscall modules will reference the documentation shown below.

* [Undocumented NTinternals](https://web.archive.org/web/20230401045934/http://undocumented.ntinternals.net/)
* [ReactOS's NTDLL Reference](https://doxygen.reactos.org/dir\_a7ad942ac829d916497d820c4a26c555.html)
* Disassembling ntdll.dll in IDA can also be beneficial.

The majority of the syscalls are exported from ntdll.dll. We can view them by opening ntdll.dll in IDA.

_<mark style="color:red;">**NOTE:**</mark>_ Syscalls provide low-level access to the operating system, by calling these functions directly acts as a bypass to EDR hooks set in place at the higher level API functions. (VirtualAlloc, CreateProcess, CreateThread, etc.)





## Syscall Service Number (SSN)

Every syscall has a Syscall Service Number (SSN). These numbers are what the kernel uses to distinguish syscalls from each other and are executed in the syscall stub (explained below). IMPORTANT: syscall service numbers are not static throughout all version of windows as they have changed over time. See the table below:

{% embed url="https://github.com/hfiref0x/SyscallTables" %}

{% embed url="https://github.com/ikermit/11Syscalls" %}

## Syscall Stub

The syscall stub or syscall structure will look like the snippet shown below.

```c
mov r10, rcx
mov eax, SSN
syscall
```

<figure><img src="../../.gitbook/assets/Screenshot 2023-09-24 190908.png" alt=""><figcaption><p>Syscall Stub for NtCreateProcess</p></figcaption></figure>



### Syscall Stub Explained

`mov r10, rcx` This moves the value of `rcx` register into `r10` register.  _<mark style="color:red;">**NOTE:**</mark>_ The `rcx` register typically holds the first argument to a function or syscall.

`mov eax, SSN` This moves the constant value SSN into the eax register. The eax register is used to specify syscall numbers, which determines which syscall the program should invoke.

`syscall` The syscall instruction when executed triggers a switch from user mode to kernel mode, transfering control to the operating systems kernel. invokes the current syscall in the eax register.

_<mark style="color:red;">**IMPORTANT:**</mark>_ &#x20;

The kernel uses the values in registers like `rax`, `rdi`, `rsi`, `rdx`, `r10`, and others to determine which syscall is being requested and to access the syscall's arguments.

`rax`: Contains the syscall number (which was loaded with `mov eax, SSN` in this case).

`rdi`, `rsi`, `rdx`, `r10`, `r8`, `r9`: These registers are used to pass arguments to the syscall.

* `rcx` holds the address of the application to be executed.
* `rdx` holds the command-line arguments.
* `r8` holds the security attributes.
* `r9` holds the security attributes for the thread.

**Test & Jne Instructions**

The `test` and `jne` instructions are for [WoW64](https://learn.microsoft.com/en-us/windows/win32/winprog64/wow64-implementation-details) purposes which are meant to allow 32-bit processes to run on a 64-bit machine. These instructions do not affect the execution flow when the process is a 64-bit process.



_**Verifying SSN Number:**_

<figure><img src="../../.gitbook/assets/Screenshot 2023-09-24 190650.png" alt=""><figcaption><p>We can check the SSN number with one of thel links above.</p></figcaption></figure>

## Syscalls In Memory

Each syscall number in memory is equal to the previous SSN + 1. For example: the first Syscall (mov eax, 0) is ZwAccessCheck and the second (mov eax,1) is NtWorkFactoryWorkReady so on so forth.

<figure><img src="../../.gitbook/assets/Screenshot 2023-09-24 191544.png" alt=""><figcaption></figcaption></figure>

_<mark style="color:red;">**NOTE:**</mark>_ Understanding that the syscalls have a relation to one another will come in handy for evasion purposes in upcoming syscall modules.



